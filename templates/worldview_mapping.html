{% extends "base.html" %}
{% block content %}
<h2>Worldview Mapping</h2>
<div id="historic-context" class="alert alert-info"></div>
<div id="map" style="height: 600px;"></div>

<!-- Timeline slider -->
<div class="my-3" style="width:100%; max-width:900px; margin:auto;">
  <label for="timeline" style="font-weight:bold;">
    Year: <span id="selected-year"></span>
  </label>
  <input
    type="range"
    id="timeline"
    min="0"
    max="{{ years|length - 1 }}"
    value="0"
    style="width:100%; display:block; margin-bottom:0.5em;"
  >
  <div id="year-labels" style="display:flex; justify-content:space-between; font-size:0.7em; margin-top:-0.5em;">
    {% for y in years %}
      <span style="display:inline-block; transform: rotate(-90deg); white-space:nowrap; font-size:0.8em;">{{ y }}</span>
    {% endfor %}
  </div>
</div>

<script>
const yearContext = {{ year_context|tojson }};

function renderYearContext(year) {
  const ctx = yearContext[year];
  if (!ctx) return "No historic context for this year.";
  // handle legacy array/string
  if (Array.isArray(ctx)) return ctx.join('<br>');
  if (typeof ctx === 'string') return ctx;
  const sections = ["Home", "South Carolina", "National", "International"];
  let html = '';
  sections.forEach(sec => {
    const items = ctx[sec];
    if (items && (Array.isArray(items) ? items.length : String(items).trim().length)) {
      html += `<h5 style="margin-top:8px;margin-bottom:4px;">${sec}</h5>`;
      if (Array.isArray(items)) {
        html += '<ul style="margin-top:0;margin-bottom:6px;padding-left:18px;">' +
                items.map(i => `<li>${i}</li>`).join('') +
                '</ul>';
      } else {
        html += `<div style="margin-bottom:6px;">${items}</div>`;
      }
    }
  });
  return html || "No historic context for this year.";
}

// usage example in updateYearDisplay:
function updateYearDisplay(idx) {
  const year = years[idx];
  selectedYear.textContent = year;
  historicContext.innerHTML = renderYearContext(year);
  updateMap(year);
}
</script>
{% endblock %}