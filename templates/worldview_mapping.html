{% extends "base.html" %}
{% block content %}
<style>
  .worldview-container {
    max-width: 1200px;
    margin: 0 auto;
  }
  
  .map-container {
    position: relative;
  }
</style>

<h2>Worldview Mapping</h2>

<div class="worldview-container">
  <!-- Map Container -->
  <div class="map-container">
    <!-- Legend -->
    <div style="position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; padding: 10px; border-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-family: Arial, sans-serif;">
      <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: bold;">Legend</h4>
      <div style="display: flex; align-items: center; margin-bottom: 5px;">
        <img src="https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png" style="width: 16px; height: 16px; margin-right: 6px;" alt="Blue dot">
        <span style="font-size: 11px;">Sent From</span>
      </div>
      <div style="display: flex; align-items: center; margin-bottom: 5px;">
        <img src="https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png" style="width: 16px; height: 16px; margin-right: 6px;" alt="Red dot">
        <span style="font-size: 11px;">Sent To</span>
      </div>
      <div style="display: flex; align-items: center; margin-bottom: 5px;">
        <div style="width: 10px; height: 10px; border-radius: 50%; background-color: green; border: 2px solid darkgreen; margin-right: 6px; margin-left: 3px;"></div>
        <span style="font-size: 11px;">Mentioned</span>
      </div>
      <div style="margin-top: 8px; padding-top: 6px; border-top: 1px solid #ddd; font-size: 9px; color: #666;">
        <em>Size = frequency</em>
      </div>
    </div>

    <div id="map" style="height: 600px; width:100%;"></div>

    <!-- Timeline slider -->
    <div class="my-3" style="width:100%; max-width:1100px; margin:auto;">
      <label for="timeline" style="font-weight:bold;">
        Year: <span id="selected-year"></span>
      </label>
      <input
        type="range"
        id="timeline"
        min="0"
        max="{{ years|length - 1 }}"
        value="0"
        style="width:100%; display:block; margin-bottom:0.5em;"
      >
      <div id="year-labels" style="display:flex; justify-content:space-between; font-size:0.7em; margin-top:-0.5em;">
        {% for y in years %}
          <span style="display:inline-block; transform: rotate(-90deg); white-space:nowrap; font-size:0.75em;">{{ y }}</span>
        {% endfor %}
      </div>
      <div id="letter-count" style="text-align: center; margin-top: 1em; font-size: 1.1em; font-weight: bold; color: #333;">
        Letters in <span id="count-year"></span>: <span id="count-value"></span>
      </div>
    </div>

    <div id="historic-context" class="alert alert-info"></div>
  </div>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
// data injected from Flask
const letterData = {{ letter_data|tojson }};
const years = {{ years|tojson }};
const yearContext = {{ year_context|tojson }};

// basic historic-context renderer
function renderYearContext(year) {
  const ctx = yearContext[year];
  if (!ctx) return "No historic context for this year.";
  if (Array.isArray(ctx)) return ctx.join('<br>');
  if (typeof ctx === 'string') return ctx;
  const sections = ["Home", "South Carolina", "National", "International"];
  let html = '';
  sections.forEach(sec => {
    const items = ctx[sec];
    if (items && (Array.isArray(items) ? items.length : String(items).trim().length)) {
      html += `<h5 style="margin-top:8px;margin-bottom:4px;">${sec}</h5>`;
      if (Array.isArray(items)) {
        html += '<ul style="margin-top:0;margin-bottom:6px;padding-left:18px;">' +
                items.map(i => `<li>${i}</li>`).join('') +
                '</ul>';
      } else {
        html += `<div style="margin-bottom:6px;">${items}</div>`;
      }
    }
  });
  return html || "No historic context for this year.";
}

// Leaflet map init
const map = L.map('map').setView([37.8, -96], 4);

L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
  maxZoom: 19,
  attribution: 'Tiles &copy; Esri'
}).addTo(map);

let markers = [];
const markersByLeafletId = {};

// Build location index
function buildLocationIndex(letters) {
  const idx = {};
  letters.forEach(letter => {
    // sent_from and sent_to
    [['sent_from','blue-dot'], ['sent_to','red-dot']].forEach(([key, icon]) => {
      const loc = letter[key];
      if (loc && loc.lat && loc.lon) {
        const k = `${loc.lat},${loc.lon}`;
        if (!idx[k]) {
          idx[k] = { name: loc.name, lat: loc.lat, lon: loc.lon, mentions: [], defaultIcon: icon };
        } else {
          if (icon !== 'green-circle') {
            idx[k].defaultIcon = icon;
          }
        }
        idx[k].mentions.push({
          letter_number: letter.letter_number,
          date: letter.date,
          file: `/static/BFPerryLettersSeparated/BFPerry_Letter${letter.letter_number}.txt`
        });
      }
    });
    
    // mentioned locations
    (letter.mentioned || []).forEach(loc => {
      if (loc && loc.lat && loc.lon) {
        const k = `${loc.lat},${loc.lon}`;
        if (!idx[k]) {
          idx[k] = { name: loc.name, lat: loc.lat, lon: loc.lon, mentions: [], defaultIcon: 'green-circle' };
        }
        idx[k].mentions.push({
          letter_number: letter.letter_number,
          date: letter.date,
          file: `/static/BFPerryLettersSeparated/BFPerry_Letter${letter.letter_number}.txt`
        });
      }
    });
  });
  return idx;
}

function getRadius(mentionCount) {
  const minRadius = 5;
  const maxRadius = 20;
  const maxMentions = 20;
  const normalized = Math.log(mentionCount + 1) / Math.log(maxMentions + 1);
  return minRadius + (normalized * (maxRadius - minRadius));
}

function makePopupHtml(locEntry, i) {
  const m = locEntry.mentions[i];
  const total = locEntry.mentions.length;
  const prevDisabled = i === 0 ? 'disabled' : '';
  const nextDisabled = i === total - 1 ? 'disabled' : '';
  
  let relationshipText = '';
  if (locEntry.defaultIcon === 'blue-dot') {
    relationshipText = `${total} letter${total > 1 ? 's' : ''} sent from this location`;
  } else if (locEntry.defaultIcon === 'red-dot') {
    relationshipText = `${total} letter${total > 1 ? 's' : ''} sent to this location`;
  } else {
    relationshipText = `${total} letter${total > 1 ? 's' : ''} mention this location`;
  }
  
  return `
    <div>
      <strong>${locEntry.name || 'Unknown'}</strong><br/>
      <span style="font-size:0.9em; color:#666;">${relationshipText}</span><br/>
      <a href="/letter/${m.letter_number}" target="_blank">View Letter ${m.letter_number}</a><br/>
      <small>${m.date || ''}</small>
      <div style="margin-top:6px; text-align:center;">
        <button onclick="cycleMention(this, -1)" data-marker-id="${locEntry._leafletId}" data-index="${i}" ${prevDisabled}>&laquo; Prev</button>
        <span style="margin:0 8px">${i + 1} / ${total}</span>
        <button onclick="cycleMention(this, 1)" data-marker-id="${locEntry._leafletId}" data-index="${i}" ${nextDisabled}>Next &raquo;</button>
      </div>
    </div>
  `;
}

function cycleMention(btn, delta) {
  const markerId = btn.getAttribute('data-marker-id');
  const currentIndex = parseInt(btn.getAttribute('data-index'), 10);
  const marker = markersByLeafletId[markerId];
  if (!marker) return;
  const locEntry = marker._locEntry;
  let newIndex = currentIndex + delta;
  if (newIndex < 0) newIndex = 0;
  if (newIndex >= locEntry.mentions.length) newIndex = locEntry.mentions.length - 1;
  const newHtml = makePopupHtml(locEntry, newIndex);
  marker.setPopupContent(newHtml);
  marker.openPopup();
}

function addAggregatedMarkers(lettersToShow) {
  markers.forEach(m => map.removeLayer(m));
  markers = [];
  Object.keys(markersByLeafletId).forEach(k => delete markersByLeafletId[k]);

  const index = buildLocationIndex(lettersToShow);
  const bounds = [];

  Object.values(index).forEach(locEntry => {
    let marker;
    if (locEntry.defaultIcon === 'green-circle') {
      const mentionCount = locEntry.mentions.length;
      const radius = getRadius(mentionCount);
      marker = L.circleMarker([locEntry.lat, locEntry.lon], { 
        radius: radius,
        color: 'darkgreen',
        fillColor: 'green',
        fillOpacity: 0.6,
        weight: 2
      });
    } else {
      const iconUrl = locEntry.defaultIcon === 'blue-dot'
        ? 'https://maps.gstatic.com/mapfiles/ms2/micons/blue-dot.png'
        : 'https://maps.gstatic.com/mapfiles/ms2/micons/red-dot.png';
      marker = L.marker([locEntry.lat, locEntry.lon], { icon: L.icon({ iconUrl, iconSize: [32,32], iconAnchor: [16,32] }) });
    }

    marker._locEntry = locEntry;
    marker.addTo(map);
    locEntry._leafletId = marker._leaflet_id;
    markersByLeafletId[String(marker._leaflet_id)] = marker;

    const popupHtml = makePopupHtml(locEntry, 0);
    marker.bindPopup(popupHtml);

    markers.push(marker);
    bounds.push([locEntry.lat, locEntry.lon]);
  });

  if (bounds.length > 0) map.fitBounds(bounds, { padding: [30,30] });
}

function updateMap(year) {
  const lettersToShow = (year === "All") ? letterData : letterData.filter(l => l.year === year);
  addAggregatedMarkers(lettersToShow);
  return lettersToShow.length;
}

const timeline = document.getElementById('timeline');
const selectedYear = document.getElementById('selected-year');
const historicContext = document.getElementById('historic-context');
const countYear = document.getElementById('count-year');
const countValue = document.getElementById('count-value');

function updateYearDisplay(idx) {
  const year = years[idx];
  selectedYear.textContent = year;
  historicContext.innerHTML = renderYearContext(year);
  const letterCount = updateMap(year);
  countYear.textContent = year;
  countValue.textContent = letterCount;
}

timeline.addEventListener('input', function() { updateYearDisplay(this.value); });

// Initialize
if (years.length > 0) {
  timeline.max = years.length - 1;
  updateYearDisplay(0);
} else {
  selectedYear.textContent = '';
  historicContext.textContent = "No years available.";
  countValue.textContent = '0';
}
</script>
{% endblock %}